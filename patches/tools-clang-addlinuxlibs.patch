From f050a6db3068aa21d16fc935339c8dded78ed6d6 Mon Sep 17 00:00:00 2001
From: Robin Sommer <robin@icir.org>
Date: Thu, 4 Jul 2013 16:42:14 -0700
Subject: [PATCH] On Linux, link with -ldl automatically when --stdlib=libc++
 is given.

---
 lib/Driver/ToolChains.cpp | 10 ++++++++++
 lib/Driver/ToolChains.h   |  3 +++
 2 files changed, 13 insertions(+)

diff --git a/lib/Driver/ToolChains.cpp b/lib/Driver/ToolChains.cpp
index fffba0e..8839f52 100644
--- a/lib/Driver/ToolChains.cpp
+++ b/lib/Driver/ToolChains.cpp
@@ -2604,6 +2604,16 @@ bool Linux::isPIEDefault() const {
   return IsPIEDefault;
 }
 
+void Linux::AddCXXStdlibLibArgs(const ArgList &Args,
+                                ArgStringList &CmdArgs) const {
+
+  ToolChain::AddCXXStdlibLibArgs(Args, CmdArgs);
+
+  if ( GetCXXStdlibType(Args) == ToolChain::CST_Libcxx ) {
+    CmdArgs.push_back("-ldl");
+  }
+}
+
 /// DragonFly - DragonFly tool chain which can call as(1) and ld(1) directly.
 
 DragonFly::DragonFly(const Driver &D, const llvm::Triple& Triple, const ArgList &Args)
diff --git a/lib/Driver/ToolChains.h b/lib/Driver/ToolChains.h
index 3afd8dd..09e9dca 100644
--- a/lib/Driver/ToolChains.h
+++ b/lib/Driver/ToolChains.h
@@ -518,6 +518,9 @@ public:
                                             ArgStringList &CC1Args) const;
   virtual bool isPIEDefault() const;
 
+  virtual void AddCXXStdlibLibArgs(const llvm::opt::ArgList &Args,
+                               llvm::opt::ArgStringList &CmdArgs) const;
+
   std::string Linker;
   std::vector<std::string> ExtraOpts;
   bool IsPIEDefault;
-- 
1.8.1.4

